name: JustRunMy Auto Renew

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 4:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 12:00ï¼‰
    - cron: '0 4 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  renew:
    runs-on: ubuntu-latest
    
    # ğŸ‘‡ åœ¨è¿™é‡Œå®šä¹‰å…¨å±€å˜é‡ï¼Œåç»­ä¿®æ”¹ç›®å½•ååªéœ€æ”¹è¿™ä¸€ä¸ªåœ°æ–¹
    env:
      WORK_DIR: justrunmy  # ä½ çš„ç›®æ ‡å­é¡¹ç›®ç›®å½•å
      
      # å¯†é’¥ç¯å¢ƒå˜é‡ï¼ˆä¿æŒä¸å˜ï¼Œä¾›åç»­æ­¥éª¤è°ƒç”¨ï¼‰
      USERNAME: ${{ secrets.JUSTRUNMY_MAIL }}
      PASSWORD: ${{ secrets.JUSTRUNMY_PASS }}
      PANEL_URL: ${{ secrets.JUSTRUNMY_PANEL_URL }}

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: yeye296/Auto-Renew-Scripts
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: scripts
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        # ğŸ‘‡ ä½¿ç”¨å˜é‡æ‹¼æ¥è·¯å¾„
        working-directory: scripts/${{ env.WORK_DIR }}
        run: pip install -r requirements.txt -q > /dev/null 2>&1

      - name: Run renew script
        # ğŸ‘‡ ä½¿ç”¨å˜é‡æ‹¼æ¥è·¯å¾„
        working-directory: scripts/${{ env.WORK_DIR }}
        run: python app.py

      - name: Commit and Push Cookie Update
        if: success()
        # ä¿æŒåœ¨ä»“åº“æ ¹ç›®å½•æ“ä½œ git
        working-directory: scripts
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # ğŸ‘‡ åœ¨ Shell è„šæœ¬ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡ $WORK_DIR
          COOKIE_TXT="${WORK_DIR}/cookies.txt"
          COOKIE_JSON="${WORK_DIR}/cookies.json"
          
          HAS_CHANGES=false
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æœ‰å˜åŒ–
          if [[ -n $(git status -s "$COOKIE_TXT" 2>/dev/null) ]]; then
            echo "æ£€æµ‹åˆ° $COOKIE_TXT æ›´æ–°"
            git add "$COOKIE_TXT"
            HAS_CHANGES=true
          fi
          
          if [[ -n $(git status -s "$COOKIE_JSON" 2>/dev/null) ]]; then
            echo "æ£€æµ‹åˆ° $COOKIE_JSON æ›´æ–°"
            git add "$COOKIE_JSON"
            HAS_CHANGES=true
          fi
          
          if [ "$HAS_CHANGES" = true ]; then
            echo "æ­£åœ¨æäº¤ Cookie..."
            git commit -m "Auto-update auth cookie in ${WORK_DIR} [skip ci]"
            git push
          else
            echo "Cookie æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          fi

      - name: ä¸Šä¼ æˆªå›¾äº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          # ğŸ‘‡ ä½¿ç”¨å˜é‡æ‹¼æ¥è·¯å¾„
          path: scripts/${{ env.WORK_DIR }}/screenshots/
          if-no-files-found: ignore
          retention-days: 7

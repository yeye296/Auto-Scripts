name: Zampto Auto Renew

on:
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘
  schedule:
    - cron: '5 4 * * *'   # æ¯å¤©å‡Œæ™¨è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write

jobs:
  run-renew:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: yeye296/zampto_renew  # ç§åº“çš„ä»“åº“ä½ç½®
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: scripts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ----------------------------------------------------------------
      # 1. ç¯å¢ƒæ£€æŸ¥ä¸ Gost ä»£ç†æœåŠ¡å¯åŠ¨
      # ----------------------------------------------------------------
      - name: å‡†å¤‡ä»£ç†ç¯å¢ƒ
        id: proxy-setup
        env:
          RAW_PROXY: ${{ secrets.CHROME_PROXY }}
        run: |
          # æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†ä»£ç†
          if [ -z "$RAW_PROXY" ]; then
            echo "â„¹ï¸ æœªé…ç½® CHROME_PROXYï¼Œå°†ä½¿ç”¨ç›´è¿æ¨¡å¼ã€‚"
            echo "USE_LOCAL_PROXY=false" >> $GITHUB_ENV
            exit 0
          fi

          echo "ğŸŒ æ£€æµ‹åˆ°ä»£ç†é…ç½®ï¼Œæ­£åœ¨å®‰è£… Gost..."
          
          # ä¸‹è½½å¹¶å®‰è£… Gost
          wget -q -O gost.gz https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz
          gunzip gost.gz
          chmod +x gost
          
          # å¯åŠ¨åå°è½¬å‘: ç›‘å¬ 8888 -> è½¬å‘ç»™ secrets ä¸­çš„ä»£ç†
          nohup ./gost -L=:8888 -F="$RAW_PROXY" > /dev/null 2>&1 &
          
          # ç­‰å¾…æœåŠ¡å°±ç»ª
          sleep 3
          
          # ç®€å•æµ‹è¯•ä¸€ä¸‹ç«¯å£æ˜¯å¦é€š
          if nc -z 127.0.0.1 8888; then
            echo "âœ… æœ¬åœ°ä»£ç†æœåŠ¡å¯åŠ¨æˆåŠŸ: 127.0.0.1:8888"
            echo "USE_LOCAL_PROXY=true" >> $GITHUB_ENV
          else
            echo "âŒ Gost å¯åŠ¨å¤±è´¥ï¼Œç«¯å£æœªå¼€æ”¾ã€‚"
            exit 1
          fi
          
      - name: Install dependencies
        working-directory: scripts
        run: pip install -r requirements.txt -q > /dev/null 2>&1
          
      # å®‰è£…ä¸­æ–‡å­—ä½“å’Œ Chrome
      - name: Install Chrome and Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable xvfb fonts-noto-cjk
          
      # ----------------------------------------------------------------
      # 2. è¿è¡Œ Python è„šæœ¬å®¹å™¨
      # ----------------------------------------------------------------
      - name: Run renew script
        working-directory: scripts
        timeout-minutes: 15  # âš ï¸ å¼ºçƒˆå»ºè®®ï¼šæ·»åŠ è¶…æ—¶é˜²æ­¢æ— é™æŒ‚èµ·æµªè´¹æ—¶é•¿
        env:
          USERNAME: ${{ secrets.ZAMPTO_MAIL }}
          PASSWORD: ${{ secrets.ZAMPTO_PASS }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_USERID: ${{ secrets.TG_USERID }}
        run: |
          # åŠ¨æ€å†³å®šä¼ ç»™å®¹å™¨çš„ä»£ç†åœ°å€
          if [ "$USE_LOCAL_PROXY" == "true" ]; then
            FINAL_PROXY="http://127.0.0.1:8888"
            echo "ğŸš€ å®¹å™¨å°†ä½¿ç”¨æœ¬åœ°è½¬å‘ä»£ç†: $FINAL_PROXY"
          else
            FINAL_PROXY=""
            echo "ğŸš€ å®¹å™¨å°†ä½¿ç”¨ç›´è¿æ¨¡å¼"
          fi
          export CHROME_PROXY="$FINAL_PROXY"
          xvfb-run -a --server-args='-screen 0 1280x800x24' python zampto_server.py
        

      - name: ä¸Šä¼ æˆªå›¾äº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: scripts/screenshots/
          if-no-files-found: ignore
          retention-days: 7
